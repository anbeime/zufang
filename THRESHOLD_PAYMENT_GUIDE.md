# 🎯 金额阈值自动确认 - 使用说明

## ✅ 已完成的功能

### 1. 智能金额判断
- ✅ **小额支付（<500元）**：自动确认，立即发券
- ✅ **大额支付（≥500元）**：需要商户确认

### 2. 商户确认页面
- ✅ 路径：`/admin/confirm-payment`
- ✅ 管理员手机号登录
- ✅ 查看待确认支付列表
- ✅ 一键确认或拒绝

### 3. 用户体验优化
- ✅ 支付成功页面显示不同提示
- ✅ 小额：显示"自动完成"
- ✅ 大额：显示"等待商户确认"

---

## 🚀 快速开始

### 1. 配置金额阈值

编辑 `.env.local` 文件：

```env
# 金额阈值（默认500元）
AUTO_CONFIRM_THRESHOLD=500
NEXT_PUBLIC_AUTO_CONFIRM_THRESHOLD=500

# 管理员手机号
ADMIN_PHONES=你的手机号
```

**说明：**
- `AUTO_CONFIRM_THRESHOLD`：服务端判断阈值
- `NEXT_PUBLIC_AUTO_CONFIRM_THRESHOLD`：前端显示阈值（必须一致）

### 2. 启动系统

```bash
npm run dev
```

访问：http://localhost:5000

---

## 📱 使用流程

### 场景一：小额支付（自动确认）

**示例：房租 300元**

```
1. 租户扫码查看账单
   ↓
2. 选择房租账单（300元）
   ↓
3. 扫个人收款码支付
   ↓
4. 点击"确认已支付"
   ↓
5. 系统自动记录（因为 300 < 500）
   ↓
6. 显示"支付成功，自动完成"
   ↓
7. 完成！
```

**特点：**
- ✅ 无需商户操作
- ✅ 立即完成
- ✅ 效率最高

---

### 场景二：大额支付（需要确认）

**示例：电费 600元**

```
1. 租户扫码查看账单
   ↓
2. 选择电费账单（600元）
   ↓
3. 扫个人收款码支付
   ↓
4. 点击"确认已支付"
   ↓
5. 系统提示"等待商户确认"（因为 600 ≥ 500）
   ↓
6. 商户打开 /admin/confirm-payment
   ↓
7. 看到待确认支付：张三 - 600元
   ↓
8. 商户点击"确认收款"
   ↓
9. 系统自动发放 70元优惠券
   ↓
10. 完成！
```

**特点：**
- ✅ 商户确认，更安全
- ✅ 自动发券
- ✅ 有支付记录

---

## 💼 商户操作指南

### 访问商户确认页面

**方式一：从首页进入**
1. 访问首页：http://localhost:5000
2. 点击"商户确认"卡片
3. 输入管理员手机号登录

**方式二：直接访问**
1. 访问：http://localhost:5000/admin/confirm-payment
2. 输入管理员手机号登录

### 确认收款

1. 登录后看到待确认列表
2. 每条记录显示：
   - 租户姓名和手机号
   - 支付类型（房租/电费）
   - 支付金额
   - 支付时间
3. 点击"✓ 确认收款"
4. 系统自动：
   - 更新账单状态为已支付
   - 如果是电费，自动发放优惠券
   - 从待确认列表移除

### 拒绝支付

1. 点击"✗ 拒绝"
2. 输入拒绝原因（可选）
3. 系统自动：
   - 更新支付状态为已拒绝
   - 账单恢复为未支付
   - 从待确认列表移除

---

## ⚙️ 配置说明

### 调整金额阈值

**场景一：降低阈值（更多需要确认）**

```env
AUTO_CONFIRM_THRESHOLD=300
NEXT_PUBLIC_AUTO_CONFIRM_THRESHOLD=300
```

效果：
- 300元以下：自动确认
- 300元及以上：需要确认

**场景二：提高阈值（更多自动确认）**

```env
AUTO_CONFIRM_THRESHOLD=1000
NEXT_PUBLIC_AUTO_CONFIRM_THRESHOLD=1000
```

效果：
- 1000元以下：自动确认
- 1000元及以上：需要确认

**场景三：全部自动确认**

```env
AUTO_CONFIRM_THRESHOLD=999999
NEXT_PUBLIC_AUTO_CONFIRM_THRESHOLD=999999
```

效果：
- 所有金额都自动确认

**场景四：全部需要确认**

```env
AUTO_CONFIRM_THRESHOLD=0
NEXT_PUBLIC_AUTO_CONFIRM_THRESHOLD=0
```

效果：
- 所有金额都需要商户确认

---

## 📊 数据库说明

### 支付状态

| 状态 | 说明 |
|------|------|
| `pending` | 待确认（大额支付） |
| `completed` | 已完成（小额自动或商户确认） |
| `rejected` | 已拒绝（商户拒绝） |

### 账单状态

| 状态 | 说明 |
|------|------|
| `unpaid` | 未支付 |
| `pending` | 待确认（大额支付） |
| `paid` | 已支付（小额自动或商户确认） |

---

## 🎨 界面说明

### 支付成功页面

**小额支付（<500元）**
```
✓ 支付成功！
支付金额：￥300.00

[绿色提示框]
✓ 支付已记录
小额支付（<￥500），自动完成
```

**大额支付（≥500元）**
```
⏳ 提交成功！
支付金额：￥600.00

[蓝色提示框]
⏳ 等待商户确认收款
金额较大（≥￥500），需要商户确认
商户确认后将自动发放优惠券
```

### 商户确认页面

```
待确认收款
共 2 笔待确认

[卡片1]
张三  13800138000
类型：⚡ 电费
时间：2024-01-15 14:30:00
                    ￥600.00
                    大额支付

[✓ 确认收款]  [✗ 拒绝]

[卡片2]
李四  13900139000
类型：🏠 房租
时间：2024-01-15 15:00:00
                    ￥800.00
                    大额支付

[✓ 确认收款]  [✗ 拒绝]
```

---

## 🔧 常见问题

### Q1: 如何修改阈值？
A: 编辑 `.env.local` 文件中的 `AUTO_CONFIRM_THRESHOLD` 和 `NEXT_PUBLIC_AUTO_CONFIRM_THRESHOLD`，重启服务。

### Q2: 商户忘记确认怎么办？
A: 待确认支付会一直保留在列表中，商户随时可以登录确认。

### Q3: 租户看到"等待确认"后能取消吗？
A: 租户无法取消，只能等待商户确认或拒绝。如需取消，请联系商户拒绝该支付。

### Q4: 商户确认后优惠券什么时候发放？
A: 商户点击"确认收款"后立即发放（仅限电费）。

### Q5: 拒绝支付后账单会怎样？
A: 账单恢复为"未支付"状态，租户可以重新支付。

### Q6: 如何查看所有支付记录？
A: 访问 `/admin` 管理后台，可以查看所有支付记录。

---

## 📈 推荐配置

### 家庭租房（推荐）
```env
AUTO_CONFIRM_THRESHOLD=500
```
- 房租（通常<500）：自动确认
- 大额电费（≥500）：商户确认

### 公寓管理
```env
AUTO_CONFIRM_THRESHOLD=1000
```
- 日常费用：自动确认
- 大额费用：商户确认

### 完全自助
```env
AUTO_CONFIRM_THRESHOLD=999999
```
- 所有费用自动确认
- 适合完全信任的场景

---

## 🎯 总结

### 系统特点
- ✅ **智能判断**：根据金额自动决定是否需要确认
- ✅ **灵活配置**：可自由调整阈值
- ✅ **安全可靠**：大额支付需要商户确认
- ✅ **高效便捷**：小额支付自动完成
- ✅ **用户友好**：清晰的状态提示

### 适用场景
- ✅ 家庭租房管理
- ✅ 公寓物业管理
- ✅ 商铺租赁管理
- ✅ 任何需要收款记录的场景

### 核心优势
- ✅ **平衡效率与安全**：小额快速，大额安全
- ✅ **完全自主控制**：钱进个人收款码
- ✅ **只做数字记录**：不涉及资金流转
- ✅ **现场支付友好**：适合当面收款

---

## 🚀 下一步

1. ✅ 配置 `.env.local` 中的阈值
2. ✅ 启动系统测试
3. ✅ 模拟小额支付（自动确认）
4. ✅ 模拟大额支付（商户确认）
5. ✅ 部署到生产环境

**祝使用愉快！** 🎊
