# 租房用电商超通系统 - 架构与流程图

## 🏗️ 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户端 (H5页面)                        │
├─────────────────────────────────────────────────────────────┤
│  入住页面  │  交费页面  │  退房页面  │  商超页面  │  我的券   │
│  /checkin  │   /pay    │ /checkout- │ /checkout │ /my-      │
│            │           │   room     │           │  coupons  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Next.js API Routes                        │
│                    (Serverless Functions)                    │
├─────────────────────────────────────────────────────────────┤
│  /api/tenants  │  /api/bills  │  /api/payments  │  /api/    │
│  /api/rooms    │  /api/coupons│  /api/supermarket-orders   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      Drizzle ORM                             │
│                   (数据库访问层)                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    PostgreSQL 数据库                         │
│         (Vercel Postgres / Supabase / Neon)                 │
├─────────────────────────────────────────────────────────────┤
│  rooms  │  tenants  │  bills  │  payments  │  coupons  │   │
│  supermarket_orders  │  contracts  │  meters  │  config    │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      文件存储                                 │
│              (Vercel Blob / Cloudflare R2)                   │
├─────────────────────────────────────────────────────────────┤
│  房间照片  │  合同文件  │  支付凭证  │  收款码图片           │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 入住流程图

```
┌─────────┐
│ 租户扫码 │
│ /checkin│
└────┬────┘
     │
     ↓
┌─────────────┐
│ 输入手机号   │
│ 输入姓名     │
│ 输入押金金额 │
└────┬────────┘
     │
     ↓
┌──────────────────┐
│ 系统自动分配房间  │
│ (第一个可用房间)  │
└────┬─────────────┘
     │
     ↓
┌──────────────┐
│ 创建租户记录  │
│ 更新房间状态  │
└────┬─────────┘
     │
     ↓
┌──────────────┐
│ 入住成功！    │
│ 显示房间号    │
└──────────────┘
```

---

## 💳 支付流程图（个人收款码）

```
┌─────────┐
│ 租户扫码 │
│  /pay   │
└────┬────┘
     │
     ↓
┌─────────────┐
│ 输入手机号   │
└────┬────────┘
     │
     ↓
┌──────────────┐
│ 查询未付账单  │
└────┬─────────┘
     │
     ↓
┌──────────────┐
│ 选择要支付的  │
│ 账单         │
└────┬─────────┘
     │
     ↓
┌──────────────────┐
│ 显示收款码弹窗    │
│ (个人微信/支付宝) │
└────┬─────────────┘
     │
     ↓
┌──────────────────┐      ┌──────────────┐
│ 用户扫码支付      │      │ 上传支付截图  │
│ (微信/支付宝)     │ ───> │ (可选)       │
└────┬─────────────┘      └────┬─────────┘
     │                          │
     ↓                          ↓
┌──────────────────┐      ┌──────────────┐
│ 点击"确认已支付"  │      │ 提交审核      │
└────┬─────────────┘      └────┬─────────┘
     │                          │
     │    ┌────────────────────┘
     │    │
     ↓    ↓
┌──────────────────┐
│ 方案A：直接完成   │ (不上传截图)
│ - 更新账单状态    │
│ - 创建支付记录    │
│ - 自动发放优惠券  │
└──────────────────┘

┌──────────────────┐
│ 方案B：待审核     │ (上传截图)
│ - 账单状态=待审核 │
│ - 支付状态=待审核 │
│ - 等待商户批准    │
└────┬─────────────┘
     │
     ↓
┌──────────────────┐
│ 商户审核          │
│ /admin/payments  │
└────┬─────────────┘
     │
     ├─────> 批准 ───> 自动发券
     │
     └─────> 拒绝 ───> 账单恢复未付
```

---

## 🛒 商超购物流程图

```
┌─────────┐
│ 租户扫码 │
│/checkout│
└────┬────┘
     │
     ↓
┌─────────────┐
│ 输入手机号   │
└────┬────────┘
     │
     ↓
┌──────────────┐
│ 查询可用优惠券│
└────┬─────────┘
     │
     ↓
┌──────────────┐
│ 输入购物金额  │
└────┬─────────┘
     │
     ↓
┌──────────────────┐
│ 系统自动匹配最优  │
│ 优惠券           │
│ (满足条件的最大额)│
└────┬─────────────┘
     │
     ↓
┌──────────────┐
│ 显示应付金额  │
│ (原价-优惠券) │
└────┬─────────┘
     │
     ↓
┌──────────────┐
│ 确认支付      │
└────┬─────────┘
     │
     ↓
┌──────────────┐
│ 创建商超订单  │
│ 核销优惠券    │
│ 支付成功！    │
└──────────────┘
```

---

## 🎫 优惠券发放规则

```
电费支付
    │
    ├─ ≥ 500元 ──> 发放 70元券 (满140可用)
    │
    ├─ ≥ 300元 ──> 发放 30元券 (满60可用)
    │
    ├─ ≥ 100元 ──> 发放 5元券 (满10可用)
    │
    └─ < 100元 ──> 不发券

商超购物
    │
    ↓
查询可用券
    │
    ├─ 有可用券 ──> 自动匹配最优券
    │                  │
    │                  ↓
    │              抵扣金额
    │
    └─ 无可用券 ──> 原价支付
```

---

## 🏠 房间管理结构

```
4层楼建筑
│
├─ 1层：商超
│
├─ 2层：住宅 (201-210)
│   ├─ 201 [可用/已租]
│   ├─ 202 [可用/已租]
│   ├─ ...
│   └─ 210 [可用/已租]
│
├─ 3层：住宅 (301-310)
│   ├─ 301 [可用/已租]
│   ├─ ...
│   └─ 310 [可用/已租]
│
└─ 4层：住宅 (401-410)
    ├─ 401 [可用/已租]
    ├─ ...
    └─ 410 [可用/已租]

总计：30个房间
```

---

## 📊 数据库关系图

```
┌──────────┐
│  rooms   │ 房间表
│  (30间)  │
└────┬─────┘
     │ 1
     │
     │ N
┌────┴─────┐
│ tenants  │ 租户表
│          │
└────┬─────┘
     │ 1
     │
     ├─────────────┐
     │             │
     │ N           │ N
┌────┴─────┐ ┌────┴─────┐
│  bills   │ │ payments │ 账单表 / 支付表
│          │ │          │
└────┬─────┘ └──────────┘
     │ 1
     │
     │ N
┌────┴─────┐
│ coupons  │ 优惠券表
│          │
└────┬─────┘
     │ N
     │
     │ 1
┌────┴──────────────┐
│ supermarket_orders│ 商超订单表
│                   │
└───────────────────┘
```

---

## 🚀 部署流程图

```
┌──────────────┐
│ 开发完成      │
└────┬─────────┘
     │
     ↓
┌──────────────────┐
│ 1. 创建数据库     │
│ (Vercel Postgres)│
└────┬─────────────┘
     │
     ↓
┌──────────────────┐
│ 2. 配置环境变量   │
│ (.env.local)     │
└────┬─────────────┘
     │
     ↓
┌──────────────────┐
│ 3. 推送数据库结构 │
│ (drizzle-kit)    │
└────┬─────────────┘
     │
     ↓
┌──────────────────┐
│ 4. 推送到 GitHub  │
└────┬─────────────┘
     │
     ↓
┌──────────────────┐
│ 5. Vercel 导入    │
│ (自动部署)        │
└────┬─────────────┘
     │
     ↓
┌──────────────────┐
│ 6. 初始化房间数据 │
│ (/api/rooms/init)│
└────┬─────────────┘
     │
     ↓
┌──────────────────┐
│ 7. 上传收款码     │
│ (/admin)         │
└────┬─────────────┘
     │
     ↓
┌──────────────────┐
│ 8. 生成二维码     │
│ (草料二维码)      │
└────┬─────────────┘
     │
     ↓
┌──────────────────┐
│ ✅ 部署完成！     │
└──────────────────┘
```

---

## 🔐 权限控制流程

```
┌──────────────┐
│ 用户访问      │
└────┬─────────┘
     │
     ├─────> 租户功能 (无需登录)
     │       ├─ 入住
     │       ├─ 交费
     │       ├─ 退房
     │       ├─ 商超购物
     │       └─ 查看优惠券
     │
     └─────> 管理员功能 (需验证手机号)
             ├─ 查看后台数据
             ├─ 审核支付
             ├─ 配置系统参数
             └─ 管理房间照片

验证方式：
- 管理员手机号白名单 (ADMIN_PHONES)
- 每次操作验证手机号
```

---

## 📱 二维码体系

```
入口二维码 (4个)
│
├─ 入住二维码
│  └─ https://your-site.vercel.app/checkin
│
├─ 交费二维码
│  └─ https://your-site.vercel.app/pay
│
├─ 退房二维码
│  └─ https://your-site.vercel.app/checkout-room
│
└─ 商超二维码
   └─ https://your-site.vercel.app/checkout

个人二维码 (可选)
│
└─ 带手机号的二维码
   └─ https://your-site.vercel.app/pay?phone=13800138000
   (扫码自动识别租户)
```

---

## 🎯 系统优势可视化

```
传统方式 vs 本系统

传统方式：
租户 ──> 联系房东 ──> 房东记账 ──> 房东收款 ──> 房东发票
      (电话/微信)   (手工/Excel)  (转账)     (手写)
      
      问题：
      ❌ 需要人工沟通
      ❌ 容易出错
      ❌ 效率低下
      ❌ 数据混乱

本系统：
租户 ──> 扫码 ──> 自动完成
      (1秒)   (所有操作)
      
      优势：
      ✅ 完全自助
      ✅ 自动记录
      ✅ 实时更新
      ✅ 数据完整
```

---

## 📈 数据流转图

```
入住
  │
  ↓
创建租户记录
  │
  ↓
分配房间
  │
  ↓
生成账单 (房租/电费)
  │
  ↓
租户支付
  │
  ↓
创建支付记录
  │
  ↓
更新账单状态
  │
  ↓
自动发放优惠券 (电费)
  │
  ↓
租户商超购物
  │
  ↓
自动核销优惠券
  │
  ↓
创建商超订单
  │
  ↓
租户退房
  │
  ↓
检查未付账单
  │
  ├─ 有未付 ──> 提示先支付
  │
  └─ 无未付 ──> 退还押金
                │
                ↓
              更新租户状态
                │
                ↓
              释放房间
```

---

## 🎉 总结

系统采用**全自动化设计**：
- ✅ 租户扫码即可完成所有操作
- ✅ 商户只需偶尔查看监控
- ✅ 数据自动记录和分析
- ✅ 优惠券自动发放和核销

**核心理念**：让技术服务生活，让管理更简单！
